<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml">
<html layout:decorate="~{layout}">


<head>
    <title>툰게더 toonGather | 회원가입</title>
    <meta charset="UTF-8">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 폰트: 'Noto Sans KR' 사용 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap">
    <!-- 프로젝트 툰게더 전용 css 스타일 시트 -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <style>
        .navbar {
          position: fixed;
          z-index: 1000;
        }
    </style>
    <script>
        //VALIDATION 1) 생년월일
            function autoFormatDate(input) {
                // Remove all non-digit characters
                let date = input.value.replace(/\D/g, '');

                // Apply the formatting based on the length of the input
                if (date.length > 4 && date.length <= 6) {
                    date = date.substring(0, 4) + '-' + date.substring(4);
                } else if (date.length > 6) {
                    date = date.substring(0, 4) + '-' + date.substring(4, 6) + '-' + date.substring(6, 8);
                }

                // Update the input value
                input.value = date;
            }

            // 생년월일을 검증하는 함수
            function validateDateOfBirth(dateOfBirth) {
                const datePattern = /^\d{4}-\d{2}-\d{2}$/; // yyyy-mm-dd 형식
                return datePattern.test(dateOfBirth);
            }

        //VALIDATION 2) 연락처
            function autoFormatPhoneNumber(input) {
                let phoneNumber = input.value.replace(/\D/g, ''); // Remove all non-digit characters
                if (phoneNumber.length > 3 && phoneNumber.length <= 7) {
                    phoneNumber = phoneNumber.substring(0, 3) + '-' + phoneNumber.substring(3);
                } else if (phoneNumber.length > 7) {
                    phoneNumber = phoneNumber.substring(0, 3) + '-' + phoneNumber.substring(3, 7) + '-' + phoneNumber.substring(7, 11);
                }
                input.value = phoneNumber;
            }


            // 연락처를 검증하는 함수
            function validatePhoneNumber(phoneNumber) {
                const phonePattern = /^\d{3}-\d{4}-\d{4}$/; // 000-0000-0000 형식
                return phonePattern.test(phoneNumber);
            }

        // 폼 제출 전에 모든 필드를 검증하는 함수

        //VALIDATION 3) 이메일
            // 이메일 형식을 확인하는 함수
            function validateEmail(email) {
                // 이메일 형식을 검증하는 정규 표현식
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailPattern.test(email);
            }

            // 폼 제출 전 이메일 형식을 검증하는 함수
            async function validateForm(event) {
            event.preventDefault(); // 폼 제출 기본 동작 방지

            const emailInput = document.querySelector('input[name="email"]');
            const email = emailInput.value;

            // const dateOfBirthInput = document.querySelector('input[name="dateOfBirth"]');
            // const dateOfBirth = dateOfBirthInput.value;

            const phoneNumberInput = document.querySelector('input[name="contactNumber"]');
            const phoneNumber = phoneNumberInput.value;

            const termsCheckbox = document.getElementById('termsAgreementCheckbox');
            var verificationCheckbox = document.getElementById('verificationCheckbox');




            // 이메일 검증
            if (!validateEmail(email)) {
                alert("이메일 형식이 올바르지 않습니다. 예: example@example.com");
                event.preventDefault(); // 폼 제출을 막음
                return;
            }

            // 생년월일 검증
            // if (!validateDateOfBirth(dateOfBirth)) {
            //     alert("생년월일 형식이 올바르지 않습니다. 예: yyyy-mm-dd");
            //     event.preventDefault(); // 폼 제출을 막음
            //     return;
            // }

            // 연락처 검증
            if (phoneNumber.length > 0 && !validatePhoneNumber(phoneNumber)) {
                alert("연락처 형식이 올바르지 않습니다. 예: 000-0000-0000");
                event.preventDefault(); // 폼 제출을 막음
                return;
            }

            // 필수 약관동의 검증
            if (!termsCheckbox.checked) {
                alert('필수 약관에 동의하지 않았습니다.');
                event.preventDefault(); // 폼 제출을 막음
                return;
            }

            // 이메일 인증 검증
            if (!verificationCheckbox.checked) {
                alert('이메일 인증을 완료해야 합니다.');
                event.preventDefault(); // 폼 제출을 막음
                return false;
            }

            // 비밀번호 일치 여부 검증
            if (!validatePasswordMatch()) {
            //alert('비밀번호를 다시 확인해주세요.'); // 비밀번호 불일치 시 경고
            return; // 폼 제출을 막음
            }



            // 중복 확인 검사
            const userId = document.getElementById('userId').value;
            const nickname = document.getElementById('nickname').value;

            // 닉네임 검증
            if(!nickname) {
                alert('닉네임을 입력해 주세요.');
                return;
            }

            if (nickname.length < 4) {
                alert('닉네임의 글자수는 최소 4자입니다.');
                return;
            }

            // 아이디는 영문과 숫자의 조합만 가능
            const validIdPattern = /^[a-zA-Z0-9]+$/;
            if (!validIdPattern.test(userId)) {
                alert('아이디는 영문과 숫자의 조합으로만 가능합니다.');
                return;
            }

            const isDuplicate = await checkDuplicates(userId, nickname, email);

            if (isDuplicate) {
            alert('중복체크를 다시 해 주세요.');
            return; // 폼 제출을 막음
            }

            // 모든 검증이 성공하면 폼을 제출
            event.target.submit();

        } //validateForm(event)

        // 비밀번호 일치 여부를 검증하는 함수
    function validatePasswordMatch() {
    const password = document.querySelector('input[name="password"]').value;
    const confirmPassword = document.querySelector('input[name="confirmPassword"]').value;

    if (!password || !confirmPassword) {
        alert('비밀번호와 비밀번호 확인란 모두 입력해 주세요.');
        return false; // 비밀번호가 입력되지 않으면 폼 제출을 막음
    }

    if (password !== confirmPassword) {
        alert('비밀번호를 다시 확인해주세요.');
        return false; // 비밀번호가 일치하지 않으면 폼 제출을 막음
    }

    return true; // 비밀번호가 일치하고 둘 다 입력되었으면 폼 제출을 진행
}


async function checkDuplicates(userId, nickname, email) {
    try {
        const responses = await Promise.all([
            fetch(`/user/checkIdDuplicate?userId=${encodeURIComponent(userId)}`),
            fetch(`/user/checkNicknameDuplicate?nickname=${encodeURIComponent(nickname)}`),
            fetch(`/user/checkEmailDuplicate?email=${encodeURIComponent(email)}`)
        ]);

        const [idResponse, nicknameResponse, emailResponse] = await Promise.all(responses.map(response => response.json()));

        if (idResponse.isDuplicate || nicknameResponse.isDuplicate || emailResponse.isDuplicate) {
            return true; // 중복이 발견되면 true 반환
        }

        return false; // 중복이 없으면 false 반환
    } catch (error) {
        console.error('Error checking duplicates:', error);
        return true; // 에러 발생 시 중복 체크 실패로 간주
    }
} //checkDuplicates


    </script>
    <script type="text/javascript">
        function sendNumber(){
        //먼저 이메일 중복체크부터
        checkEmailDuplicate();
    $.ajax({
        url:"/user/mail/mailSend",
        type:"post",
        contentType: "application/json; charset=UTF-8",
        dataType:"json",
        data:JSON.stringify({ "mail": $("#email").val() }),
        success: function(data){
            alert("인증번호를 발송했습니다. 메일을 확인해주세요.");
        },
        }
    );
}

function confirmNumber() {
    $.ajax({
        url: "/user/mail/mailCheck",
        type: "get",
        dataType: "json",
        data: { "userNumber": $("#mailNumber").val() },
        success: function(response) {
            if (response === true) {
                // 인증이 성공한 경우 hidden checkbox를 체크
                $("#verificationCheckbox").prop("checked", true);
                // 이메일 입력 박스를 readonly로 설정
                $("#email").prop("readonly", true);
                alert("인증되었습니다.");
            } else {
                // 인증이 실패한 경우
                $("#verificationCheckbox").prop("checked", false);
                alert("인증번호가 일치하지 않습니다.");
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error("인증 요청 실패:", textStatus, errorThrown);
            alert("인증 과정 중 오류가 발생했습니다.");
        }
    });
}


    </script>
</head>
<body>

<div th:replace="~{common/menubar}"></div>
<style>
    .jumbotron {
    position : relative;
    background-color : #EEEEEE;
    }
    .jumbotron .row {
    position : absolute;
    width : 100%;
    bottom: 0%;
    }

    #loginbox {
    border-radius : 5%;
    border-color : #F2F2F2;
    }

    .form-control {
    background-color : #FCFCFC;
    border : none;
    width : 100%;
    height : 50px;
    }

    .logininput {
    background-color : #FCFCFC;
    border : none;
    height : 50px;
    }

    .logininput::placeholder {
    color : #BBBBBB;
    }

    button {
    background-color : #03C75A;
    }

    .form-select {
    background-color : #FCFCFC;
    border : none;
    width : 100%;
    height : 50px;
    }

    .form-check-input {
    accent-color: #03C75A;
    }

     .nav-link {
            color: #828282;
    }
    ul {
  list-style: none;
  padding-left : 0px;
  }

    .required-star {
        color: #03C75A;
    }

</style>
<div class="jumbotron">
    <div class="container">
        <div class="row">
            <div class="col-9">
                <div class="row">
                    <div class="col-md-3 px-4">
                        <h3>회원 가입</h3>
                    </div>
                    <div class="col-md-9">
                        <nav class="navbar navbar-expand-md">
                            <ul class="nav col-12 col-md-auto mb-4 justify-content mb-md-3">
                                <li>-</li>
                                <!--          <li><a th:href="@{/user/my/in/journal}" class="nav-link px-2">좋아요한 웹툰소식</a></li>-->
                                <!--          <li><a th:href="@{/user/my/in/event}" class="nav-link px-2">좋아요한 행사</a></li>-->
                                <!--          <li><a th:href="@{/user/my/in/merchan}" class="nav-link px-2">좋아요한 굿즈</a></li>-->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container" style="padding:0;">
    <div class="container" style="padding:0;">
        <div class="row">
            <aside class="col-md-3 px-4">
                <div class="row">
                    <div class="col-3"></div>
                    <div class="col-6">
                        <div class="panel">
                            <ul class="list-group">
                                <li><a th:href="@{/user/login}" class="nav-link px-2">로그인</a></li>
                                <li><a th:href="@{/user/signup}" class="nav-link px-2" style="color: #03C75A;">회원가입</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </aside>
            <script>
                // id available check
                function checkIdDuplicate() {
                    const userId = document.getElementById('userId').value;

                    if(!userId) {
                        alert('아이디를 입력해 주세요.');
                        return;
                    }

                    if (userId.length < 4) {
                        alert('아이디의 글자수는 최소 4자입니다.');
                        return;
                    }

                    // 아이디는 영문과 숫자의 조합만 가능
                    const validIdPattern = /^[a-zA-Z0-9]+$/;
                    if (!validIdPattern.test(userId)) {
                        alert('아이디는 영문과 숫자의 조합으로만 가능합니다.');
                        return;
                    }

                    fetch(`/user/checkIdDuplicate?userId=${encodeURIComponent(userId)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.isDuplicate) alert('이미 존재하는 아이디입니다. ');
                            else alert('사용 가능한 아이디입니다.');
                        })
                        .catch(error => {
                            console.error('Error: ', error);
                        });
                } //checkIdDuplicate()

                // nickname available check
                function checkNicknameDuplicate() {
                    const nickname = document.getElementById('nickname').value;

                    if(!nickname) {
                        alert('닉네임을 입력해 주세요.');
                        return;
                    }

                    if (nickname.length < 4) {
                        alert('닉네임의 글자수는 최소 4자입니다.');
                        return;
                    }

                    fetch(`/user/checkNicknameDuplicate?nickname=${encodeURIComponent(nickname)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.isDuplicate) alert('이미 사용 중인 닉네임입니다.');
                            else alert('사용 가능한 닉네임입니다.');
                        })
                        .catch(error => {
                            console.error('Error: ', error);
                        });
                } //checkNicknameDuplicate()

                // email available check
                function checkEmailDuplicate() {
                    const email = document.getElementById('email').value;

                    if(!email) {
                        alert('이메일을 입력해 주세요.');
                        return;
                    }

                    // 이메일 검증
                    if (!validateEmail(email)) {
                        alert("이메일 형식이 올바르지 않습니다. 예: example@example.com");
                        return;
                    }

                    fetch(`/user/checkEmailDuplicate?email=${encodeURIComponent(email)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.isDuplicate) alert('이미 등록된 이메일입니다.');
                            //else alert('등록 가능한 이메일입니다.');
                        })
                        .catch(error => {
                            console.error('Error: ', error);
                        });
                } //checkEmailDuplicate()
            </script>
            <div class="col-md-9">
                <div class="row justify-content-start" style="color: #828282;">
                    <div class="col-8 p-3" id="loginbox">
                        <form th:action="@{/user/signup}" th:object="${user}" method="post"
                              onsubmit="validateForm(event)">
                            <div class="row p-2">
                                <div class="col-3">
                                    아이디 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input class="form-control px-3" type="text" th:field="*{userId}" maxlength="20"
                                           minlength="4"/>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-primary btn-block"
                                            style="background-color:#03C75A;" onclick="checkIdDuplicate()">중복확인
                                    </button>
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    비밀번호 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input class="form-control px-3" type="password" th:field="*{password}"
                                           maxlength="30" minlength="8"/>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    비밀번호 확인 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input class="form-control px-3" type="password" th:field="*{confirmPassword}"
                                           maxlength="30" minlength="8"/>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    닉네임 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input class="form-control px-3" type="text" th:field="*{nickname}" maxlength="20"
                                           minlength="4"/>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-primary btn-block"
                                            style="background-color:#03C75A;" onclick="checkNicknameDuplicate()">중복확인
                                    </button>
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    연락처
                                </div>
                                <div class="col-6">
                                    <input class="form-control px-3 logininput" type="text" th:field="*{contactNumber}"
                                           oninput="autoFormatPhoneNumber(this)" placeholder="000-0000-0000"/>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    성별
                                </div>
                                <div class="col-6">
                                    <select class="form-select px-3" th:field="*{gender}">
                                        <option value="P">성별을 공개하지 않습니다</option>
                                        <option value="F">여</option>
                                        <option value="M">남</option>
                                    </select>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    <!-- 생년월일을 연도, 월, 일로 나누어 드롭다운 박스 형태로 입력 -->
                                    생년월일
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-4">
                                            <select class="form-select" id="year" name="year" th:field="*{year}"
                                                    style="text-align:center;">
                                                <option th:each="y : ${years}" th:value="${y}" th:text="${y}">연도
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-4">
                                            <select class="form-select" id="month" name="month" th:field="*{month}"
                                                    style="text-align:center;">
                                                <option th:each="m : ${months}" th:value="${m}" th:text="${m}">월
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-4">
                                            <select class="form-select" id="day" name="day" th:field="*{day}"
                                                    style="text-align:center;">
                                                <option th:each="d : ${days}" th:value="${d}" th:text="${d}">일</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    실명
                                </div>
                                <div class="col-6">
                                    <input class="form-control" type="text" th:field="*{realName}" maxlength="10"/>
                                </div>
                                <div class="col-3">
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    이메일 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input id="email" class="form-control" type="text" th:field="*{email}"/>
                                </div>
                                <div class="col-3">
                                    <!--                            <button type="button" class="btn btn-primary btn-block" style="background-color:#03C75A;" onclick="checkEmailDuplicate()">중복확인</button>-->
                                    <button type="button" class="btn btn-primary btn-block"
                                            style="background-color:#03C75A;" onclick="sendNumber()">인증하기
                                    </button>
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-3">
                                    인증번호 입력 <span class="required-star">*</span>
                                </div>
                                <div class="col-6">
                                    <input id="mailNumber" class="form-control" type="text" th:field="*{mailNumber}"/>
                                    <!-- 실제로는 보이지 않지만 폼에 포함될 hidden checkbox -->
                                    <input type="checkbox" id="verificationCheckbox" name="verificationCheckbox"
                                           style="display:none;"/>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-primary btn-block"
                                            style="background-color:#03C75A;" onclick="confirmNumber()">인증확인
                                    </button>
                                </div>
                            </div>
                            <div class="row p-2">
                                <div class="col-6">
                                    자기소개(선택사항)
                                </div>
                                <div class="col-6">
                                </div>
                                <div class="col-12">
                                    <textarea class="form-control logininput" rows="3" maxlength="150" th:field="*{bio}"
                                              placeholder="본인을 자유롭게 표현해주세요.&#13;&#10;소개 내용은 소셜 페이지에 활용됩니다!"></textarea>
                                </div>
                            </div>

                            <div class="col-12 p-2">


                            </div>
                            <div class="form-check col-12 p-2">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="checkbox" id="termsAgreementCheckbox"
                                           th:field="*{termsAgreement}" style="color: white;"/>
                                    [필수] <span class="required-star">*</span> 본인은 툰게더 회원 약관에 동의하였으며, <br>
                                    툰게더 커뮤니티 이용 수칙에 동의하는 바입니다.
                                </label>
                            </div>
                            <div class="col-12 p-2">
                                <button type="submit" class="btn btn-primary btn-block"
                                        style="background-color:#03C75A; height:50px;">가입하기
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="common/footer.html"></div>
</body>
</html>