<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml">
<html layout:decorate="~{layout}">
<head>
  <title>KHG70: 프로필수정</title>
  <meta charset="UTF-8">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- 폰트: 'Noto Sans KR' 사용 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap">
  <!-- 프로젝트 툰게더 전용 css 스타일 시트 -->
  <link rel="stylesheet" th:href="@{/css/styles.css}">

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


  <style>
    .navbar {
      position: fixed;
      z-index: 1000;
    }
  </style>
  <script>
    //VALIDATION 1) 생년월일
        function autoFormatDate(input) {
            // Remove all non-digit characters
            let date = input.value.replace(/\D/g, '');

            // Apply the formatting based on the length of the input
            if (date.length > 4 && date.length <= 6) {
                date = date.substring(0, 4) + '-' + date.substring(4);
            } else if (date.length > 6) {
                date = date.substring(0, 4) + '-' + date.substring(4, 6) + '-' + date.substring(6, 8);
            }

            // Update the input value
            input.value = date;
        }

        // 생년월일을 검증하는 함수
        function validateDateOfBirth(dateOfBirth) {
            const datePattern = /^\d{4}-\d{2}-\d{2}$/; // yyyy-mm-dd 형식
            return datePattern.test(dateOfBirth);
        }

    //VALIDATION 2) 연락처
        function autoFormatPhoneNumber(input) {
            let phoneNumber = input.value.replace(/\D/g, ''); // Remove all non-digit characters
            if (phoneNumber.length > 3 && phoneNumber.length <= 7) {
                phoneNumber = phoneNumber.substring(0, 3) + '-' + phoneNumber.substring(3);
            } else if (phoneNumber.length > 7) {
                phoneNumber = phoneNumber.substring(0, 3) + '-' + phoneNumber.substring(3, 7) + '-' + phoneNumber.substring(7, 11);
            }
            input.value = phoneNumber;
        }


        // 연락처를 검증하는 함수
        function validatePhoneNumber(phoneNumber) {
            const phonePattern = /^\d{3}-\d{4}-\d{4}$/; // 000-0000-0000 형식
            return phonePattern.test(phoneNumber);
        }

    // 폼 제출 전에 모든 필드를 검증하는 함수

    //VALIDATION 3) 이메일
        // 이메일 형식을 확인하는 함수
        function validateEmail(email) {
            // 이메일 형식을 검증하는 정규 표현식
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        // 폼 제출 전 이메일 형식을 검증하는 함수
        function validateForm(event) {
        const emailInput = document.querySelector('input[name="email"]');
        const email = emailInput.value;

        const dateOfBirthInput = document.querySelector('input[name="dateOfBirth"]');
        const dateOfBirth = dateOfBirthInput.value;

        const phoneNumberInput = document.querySelector('input[name="contactNumber"]');
        const phoneNumber = phoneNumberInput.value;

        // 이메일 검증
        if (!validateEmail(email)) {
            alert("이메일 형식이 올바르지 않습니다. 예: example@example.com");
            event.preventDefault(); // 폼 제출을 막음
            return;
        }

        // 생년월일 검증
        if (!validateDateOfBirth(dateOfBirth)) {
            alert("생년월일 형식이 올바르지 않습니다. 예: yyyy-mm-dd");
            event.preventDefault(); // 폼 제출을 막음
            return;
        }

        // 연락처 검증
        if (!validatePhoneNumber(phoneNumber)) {
            alert("연락처 형식이 올바르지 않습니다. 예: 000-0000-0000");
            event.preventDefault(); // 폼 제출을 막음
            return;
        }
    }
  </script>
</head>
<body>

<div th:replace="~{common/menubar}"></div>
<style>
  .jumbotron {
  position : relative;
  }
  .jumbotron .row {
  position : absolute;
  width : 100%;
  bottom: 0%;
  }
</style>
<div class="jumbotron">
  <div class="row">
    <div class="col-md-3">
      <h3>프로필 수정</h3>
    </div>
    <div class="col-md-9">
      <nav class="navbar navbar-expand-md">
        <ul class="nav col-12 col-md-auto mb-4 justify-content mb-md-3">
          <li>-</li>
<!--          <li><a th:href="@{/user/my/in/journal}" class="nav-link px-2">좋아요한 웹툰소식</a></li>-->
<!--          <li><a th:href="@{/user/my/in/event}" class="nav-link px-2">좋아요한 행사</a></li>-->
<!--          <li><a th:href="@{/user/my/in/merchan}" class="nav-link px-2">좋아요한 굿즈</a></li>-->
        </ul>
      </nav>
    </div>
  </div>
</div>
<div class="row">
  <aside class="col-md-3">
    <div class="panel">
      <ul class="list-group">
        <li><a th:href="@{/user/my}" class="nav-link px-2">나의 웹툰</a></li>
        <li><a th:href="@{/user/my/so/review}" class="nav-link px-2">나의 소셜</a></li>
        <li><a th:href="@{/user/my/rct/job}" class="nav-link px-2">나의 채용</a></li>
        <li><a th:href="@{/user/my/in/journal}" class="nav-link px-2">나의 소식</a></li>
        <li><a th:href="@{/user/my/editprofile}" class="nav-link px-2">프로필 수정</a></li>
        <li><a th:href="@{/user/my/cs}" class="nav-link px-2">나의 문의</a></li>
      </ul>
    </div>
  </aside>
  <script>
    // nickname available check
        function checkNicknameDuplicate() {
            const nickname = document.getElementById('nickname').value;

            if(!nickname) {
                alert('닉네임을 입력해 주세요.');
                return;
            }

            fetch(`/user/checkNicknameDuplicate?nickname=${encodeURIComponent(nickname)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.isDuplicate) alert('이미 사용 중인 닉네임입니다.');
                    else alert('사용 가능한 닉네임입니다.');
                })
                .catch(error => {
                    console.error('Error: ', error);
                });
        } //checkNicknameDuplicate()

        // email available check
        function checkEmailDuplicate() {
            const email = document.getElementById('email').value;

            if(!email) {
                alert('이메일을 입력해 주세요.');
                return;
            }

            fetch(`/user/checkEmailDuplicate?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.isDuplicate) alert('이미 등록된 이메일입니다.');
                    else alert('등록 가능한 이메일입니다.');
                })
                .catch(error => {
                    console.error('Error: ', error);
                });
        } //checkEmailDuplicate()
  </script>
  <div class="col-md-9">
    <form th:action="@{/user/my/editprofile}" th:object="${user}" method="post" enctype="multipart/form-data" onsubmit="validateForm(event)">
      프로필 사진<br>
      <img th:src="@{/uploadFiles/{fileName}(fileName=${user.profileImagePath})}" style="width: 100px; height: auto;"/><br>
      <input type="file" name="image"><br>
      아이디 : <input type="text" th:field="*{userId}" maxlength="20" minlength="4" readonly/><br>
      비밀번호 : <input type="password" th:field="*{password}" maxlength="30" minlength="8"/><br>
      비밀번호 확인 : <br>
      닉네임 : <input type="text" th:field="*{nickname}" maxlength="20" minlength="4"/>
      <button type="button" onclick="checkNicknameDuplicate()">중복확인</button>
      <br>
      연락처 : <input type="text" th:field="*{contactNumber}" oninput="autoFormatPhoneNumber(this)" placeholder="000-0000-0000"/><br>
      성별 : <select th:field="*{gender}">
      <option value="P">성별을 공개하지 않습니다
      <option value="F">여
      <option value="M">남</select><br>
      생년월일 : <input type="text" th:field="*{dateOfBirth}" oninput="autoFormatDate(this)" placeholder="yyyy-mm-dd"/><br>
      이메일 : <input type="text" th:field="*{email}"/>
      <button type="button" onclick="checkEmailDuplicate()">중복확인</button>
      <br>
      자기소개(선택사항) : <input type="text" th:field="*{bio}"/><br>

      <input type="submit">수정확인<br>
    </form>

    <form th:action="@{/user/my/deleteprofile}" method="post">
      <button type="submit">탈퇴하기(누르면 바로 삭제되니 조심!)</button>
    </form>
  <!--    <form th:action="@{/user/signup}" th:object="${user}" method="post">-->
  <!--        아이디 : <input type="text" name="userId"><br>-->
  <!--        비밀번호 : <input type="password" name="password"><br>-->
  <!--        비밀번호 확인 : <br>-->
  <!--        닉네임 : <input type="text" name="nickname"><br>-->
  <!--        연락처 : <input type="text" name="contactNumber"><br>-->
  <!--        성별 : <select name="gender">-->
  <!--        <option>성별을 공개하지 않습니다-->
  <!--        <option>여-->
  <!--        <option>남</select><br>-->
  <!--        생년월일 : <input type="text" name="dateOfBirth"><br>-->
  <!--        이메일 : <input type="text" name="email"><br>-->
  <!--        자기소개(선택사항) : <input type="text" name="bio"><br>-->
  <!--        <input type="checkbox" name="termsAgreement">본인은 툰게더 회원 약관에 동의합니다.<br>-->

  <!--        <input type="submit">가입하기-->
  <!--    </form>-->
  </div>
</div>
</body>
</html>